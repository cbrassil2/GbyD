---
title: "Grades by Demographics"
date: "`r Sys.Date()`"
output: 
#  pdf_document
  rmdformats::readthedown:
    toc_depth: 3
always_allow_html: true
---

```{r Libraries, include=FALSE, message = FALSE}
# Installs and loads required packages if they are not already installed
if (!require("rmdformats")) install.packages("rmdformats")
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("gt")) install.packages("gt")
if (!require("ggiraph")) install.packages("ggiraph")
if (!require("scales")) install.packages("scales")
#Ensure working directory is the same as this file
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
```

```{r Data, include=FALSE, message = FALSE}
### MODIFY THIS LINE, REPLACING "data_sim.csv" WITH THE NAME OF YOUR DATA ###
# Have data file be in the same folder as this R Markdown file.

ds <- read_csv("data_sim.csv")

### More info ###
# By default, the code looks for data_sim.csv file in the same folder in which you have this R file. It is synthetic data which matches real general demographic patterns, but which does represent any individual section or student. 
# You can replace that with your own institutional data similar to the data_sim.csv. Each row is an individual student for an individual course in a single term. All data for all courses and all terms is listed in a single table, with columns for course and term. A student may appear in the data set multiple times if they repeated a course or if multiple courses are represented in the data. 
#
## Critically, you need the columns with the following titles:
#
# course - you can use any name or code that is understandable to your institutional audience
# grade - course letter grades, +/- is optional, will ignore anything outside of A+ through F or W.
#
## Optionally, you can include:
#
# term or semester - ideally coded as season and year or month and year, for example "Fall 2023" or "August 2023".
#
##Then include other columns named however you want it labelled in the report (for example with a capital letter). Similarly, entries for that column should be formatted as you want them displayed in the report (for example "Female" or "F"). You can use any spreadsheet program to format or rename these as desired. If your data is in Excel format, save it as a csv file.

### OPTIONALLY, MODIFY THESE PARAMETERS ###
#

threshold <- 5 #Threshold number of students needed in order for a demographic combination to be disaggregated. The standards for most schools are 5 or 10

show_GPA_excluding_DF <- FALSE #Set to TRUE to show GPA excluding DF and switch DFW to Success = 1-DFW so that direction of figures is aligned. Set to FALSE to hide GPA exclude DF figures and tables and show DFW not 1-DFW

hide_NA <- TRUE #Set to FALSE to show NA's in fields. Set to TRUE to hide NAs.

censor_by_removal <- TRUE #Set to TRUE to remove just the categories that don't meet the threshold. Set to FALSE to keep all data but aggregate when any one category does not meet the threshold.

which_courses <- "all" #Set to "all" to do all courses in the file. Replace with a course name, such as "Calc1" or a list of courses, such as c("Calc1","Chem1") to display just some courses.

#
```

```{css Format Tables, echo=FALSE}
.gt_table {
  float:left;
}

/* the following line overrides the alternating background colors in tables for readthedown */
table:not(.dataTable) tr:nth-child(2n-1) {
    background-color: white;
}

.questionbox {
  padding: 1em;
  background:#DFDFDF;
  color: black;
  border: 2px solid maroon;
  font-size: 18 px
}

.center {
  text-align: center;
}
```


```{=latex}
\usepackage{color}
\usepackage{framed}
\setlength{\fboxsep}{.8em}

\newenvironment{questionbox}{
  \definecolor{shadecolor}{rgb}{0, 0, 0}  % black
  \color{white}
  \begin{shaded}}
 {\end{shaded}}
```


```{r Check Data and Grade Derivatives, include = FALSE, eval = TRUE}
# List of equivalent column names here:
courseColumns <- c("course","Course","class","Class")
gradeColumns <- c("grade","Grade","Letter_Grade","letter_grade", "Letter Grade", "letter grade")
termColumns <- c("term","Term","semester","Semester","year_and_semester","Year_and_Semester")

# Check for "course"
if (!any(courseColumns %in% names(ds))) stop("'course' column not found")
# Check for "grade"
if (!any(gradeColumns %in% names(ds))) stop("'grade' column not found")

season_list = c("January","january","Jan","jan","February","february","Feb","feb","March","march","April","april","Apr","apr","May","may","June","june","Jun","jun","July","july","Jul","jul","August","august","Aug","aug","September","september","Sept","sept","Sep","October","october","Oct","oct","November","november","Nov","nov","December","december","Dec","dec","Q1","Q2","Q3","Q4","First","One","Second","Two","Third","Three","Fourth","Four","J-term","j-term","Winter","winter","Spring","spring","Summer","summer","Fall","fall") #include possible names in order

#note, this is currently not robust to listing by academic year that include seasons. Rather, it assumes list is by year and season or month. However, adjusting the order in the above season_list will fix that.

# Change column names to standard names use throughout the rest of the code below  
ds %>%  
  rename(course = names(ds)[names(ds) %in% courseColumns][1 ]) %>% #rename the first listing courseColumns to course
  filter( which_courses == "all" | course %in% which_courses) %>% #filter courses if which_courses is set to anything besides "all"
  rename(grade = names(ds)[names(ds) %in% gradeColumns][1] )  %>% #rename the first listing gradeColumns to grade
  mutate(course = factor(course)) %>% #turn course into a factor
  rename(term = names(ds)[names(ds) %in% termColumns][1] ) %>% #rename the first listing termColumns to term
  arrange(grade) %>% #the next lines attempt to process term so that it correctly ordered
  mutate(year = str_extract(term,"[0-9]+"), season = str_extract(term,"[A-Za-z]+")) %>%
  mutate(season = factor(season, levels = season_list)) %>%
  mutate(season = factor(season), year = fct_inseq(year)) %>%
  arrange(year, season) %>%
  mutate(term = fct_inorder(term)) %>%
  select(-year,-season) -> ds  

# Isolate demographic columns
demographicCols <- names(ds)[!(names(ds) %in% courseColumns | names(ds) %in% termColumns | names(ds) %in% gradeColumns)]

# Add a grade_point and a DFW column to the data
ds %>%
  mutate(grade_point = case_when(
    grade == "A+" ~ 4.0,
    grade == "A" ~ 4.0,
    grade == "A-" ~ 3.67,
    grade == "B+" ~ 3.33,
    grade == "B" ~ 3.0,
    grade == "B-" ~ 2.67,
    grade == "C+" ~ 2.33,
    grade == "C" ~ 2.0,
    grade == "C-" ~ 1.67,
    grade == "D+" ~ 1.33,
    grade == "D" ~ 1.0,
    grade == "D-" ~ 0.67,
    grade == "F" ~ 0.0,
    TRUE ~ NaN)) %>%
  mutate(ABCDFW = case_when(
    grade %in% c("A+","A","A-","B+","B","B-","C+","C","C-") ~ "ABC",
    grade %in% c("D+","D","D-","F","W") ~ "DFW",
    TRUE ~ NA)) -> dt

firstTerm = levels(dt$term)[1]
lastTerm = last(dt$term)
```

The report includes grades from `r firstTerm` to `r lastTerm`.

# Introduction

This report is designed to enable instructors to self-reflect on how course letter grades differ by demographics. This reflection can be the most sustainable and is the most likely to result in productive change, when done in the context of a supportive environment of other instructors, what has been called a Learning Community or Community of Practice.

## Context of Prior Experiences

Differential student success by demographics in a given course is at least partially a consequence of differential prior student experience. Demographic differences in student success imply correlated barriers or benefits experienced by students, even if the details of those barriers are unknown. 

It is difficult to quantify reductions an instructor may already be achieving in demographic differences because differential student success is only realized in the context of a give course at a given point in the life and development of a student. In other words, demographic differences may have been much greater if not for the efforts of the instructor, and it is difficult to demonstrate. 

At the same time, instructors are challenged, by the nature of their profession, to utilize pedagogical strategies that aim to reduce demographic differences in course performance as much as possible. Educators are enabled and even compelled to provide an equal opportunity to all students by helping students navigate barriers, which can include preemptively and proactively changing course structure and adopting effective pedagogy. A reduction of demographic differences needs to be celebrated because instructors are likely utilizing effective pedagogical strategies that are countering societal forces beyond their classroom, consequently enabling success for all their students.

## Navigation of Figures

In the figures, the sizes of the circles are proportional to the number of students in the category. Mouse over a circle for specific details on the number of students, the percentage of students that represents, and details on grades.

`r if(show_GPA_excluding_DF) "In some cases, figures are shown for **DFW** and for **GPA excluding DF**. The later is the grade point average in a give class for students who achieved an A, B, or C. It is a compliment to disaggregated DFW rates because it disaggregates high achieveing students."`

Mouse over the grey rectangle for details on the differences between the maximum and minimum circle. The **Percentage Points Gap** is the difference between the highest and lowest. The **Grade Ratio** is the highest divided by the lowest rate, in other words "how many times greater". When examining DFW, the **Students in Gap** is how many students, summed across the time period display, would have earned in ABC instead of a DFW if the highest DFW percent were lowered to the equivalent of the lowest DFW percent. In other words, it translates the gap from a percentage to units of individuals. Finally, **Total Enrollments** is the sum of total students across all categories.

# Single Demographics

::: {.questionbox data-latex=""}
::: {.center data-latex=""}
**Guiding questions:**
:::


-   Are these course supporting students differently? Why might they support some students better than others?

-   For what students are these courses working well?

`r if(show_GPA_excluding_DF) "-   The **DFW Rates** includes all students. The **Grade Point for ABC Students** excludes students with D or F grades in order to focus on those students who achieved an A, B, or C in the first figure. Are disaggregated patterns in DFW rates similar or different from patterns in Grade Point for ABC Students?"`

-   What additional information about these courses or these students would you want to collect to address these questions?
:::

```{r Single Demographics, results='asis', echo=FALSE, include=TRUE, eval = TRUE}
#initialize
metThresholds  <- tibble(
  course = factor(),
  met = logical(),
  unmet_list = character(),
  demograph = character())

#determine which categories have met minimum thresholds
# Note that 'threshold' is manually set in top chunk above.
for (i in demographicCols) {
dt %>%
  group_by(course) %>%
  filter(if_else( hide_NA & ( is.na(!!sym(i)) | !!sym(i) %in% c("","NA","NaN") ),FALSE,TRUE) ) %>% #filter out NA values or equivalent
  count(!!sym(i)) %>% #!!sym(i) take the string feed to it in the for loop and turns it into a symbol
  group_by(course) %>%
  mutate(met = !max(n < threshold)) %>% #threshold
  mutate(unmet_pre_list = if_else(n < threshold, if_else(is.na(!!sym(i)),"NA",!!sym(i)),NA) ) %>%
  mutate(unmet_list = str_flatten(unmet_pre_list, collapse = ", ", last = " and ", na.rm = TRUE)) %>%
  select(course,met,unmet_list) %>%
  distinct() %>%
  mutate(demograph = i) %>%
  union_all(metThresholds) -> metThresholds
}

metThresholds %>%
  filter(met == TRUE) %>%
  mutate(demograph = factor(demograph))-> combosToPlot

#Get names of course and demographic combinations that did not met the threshold
metThresholds %>%
  filter(met == FALSE) %>%
  group_by(demograph, unmet_list) %>%
  summarise(courses = str_flatten(course, collapse = ", ", last = " and "), .groups = "drop" ) %>%
  transmute(unmet = paste("-",demograph,"for",courses, "had too few students in the category", unmet_list)) %>%
  pull(unmet) %>%
  paste0(collapse = "\n\n")-> droppedCols

#Print names of removed columns
if (droppedCols != "") cat("\nThe following are not shown because they did not meet minimum threshold of students for all categories:\n\n",droppedCols,'\n', sep="")

# Generate a table for each demographic category included
for (i in levels(combosToPlot$demograph)) {

combosToPlot %>% 
    filter(demograph == i) %>%
    select(course) %>%
    distinct() -> courseList #Tibble of courses that met threshold for this demographic

#DFW 
dt %>%
  {if(censor_by_removal == FALSE) right_join(.,courseList, by = c("course")) else .} %>% #only keep the courses that met thresholds for this demographic
  filter(if_else( hide_NA & ( is.na(!!sym(i)) | !!sym(i) %in% c("","NA","NaN") ),FALSE,TRUE) ) %>% #filter out NA values or equivalent
  group_by(course, !!sym(i)) %>%
#  filter(if_else( censor_by_removal & n() < threshold,FALSE,TRUE)) %>% #filter out censor_by_removal categories
#  summarize(DFW_rate = sum(ABCDFW == "DFW")/n(), DFW = paste0(percent(sum(ABCDFW == "DFW")/n(),accuracy=0.1),"<br><span style='white-space: nowrap;'>(",sum(ABCDFW == "DFW")," of ",n(),")</span>"),  .groups = "drop" ) %>%
  summarize(DFW_rate = if_else( censor_by_removal & n() < threshold,NA,sum(ABCDFW == "DFW")/n()), DFW = if_else( censor_by_removal & n() < threshold, "Below Threshold", paste0(percent(sum(ABCDFW == "DFW")/n(),accuracy=0.1),"<br><span style='white-space: nowrap;'>(",sum(ABCDFW == "DFW")," of ",n(),")</span>")),  .groups = "drop" ) %>%
  group_by(course) %>%
  mutate(Gap = max(DFW_rate) - min(DFW_rate)) %>%
  select(-DFW_rate) %>%
  pivot_wider(names_from = !!i, values_from=DFW) %>%
#  group_by(course) %>%
#  mutate(Gap = max(across(!matches("course"))) - min(across(!matches("course")))) %>%
  relocate(Gap, .after = "course") %>%
  mutate(demCat = i) %>% 
  group_by(demCat) %>%
  gt(rowname_col="course") %>% # Table creation starts here
  fmt_markdown(columns = !c("course","Gap","demCat")) %>%
  fmt_percent(decimals = 1, rows = everything()) %>%
  sub_missing(missing_text="") %>%
  tab_style(
    style = cell_text(v_align = "top"),
    locations = list(cells_body(columns = everything()), cells_stub())) %>%
  tab_style_body(
      style = cell_fill(color = "yellow2"),
      values = "Below Threshold") %>%      
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(columns = Gap)) -> table

#Success 
dt %>%
  {if(censor_by_removal == FALSE) right_join(.,courseList, by = c("course")) else .} %>% #only keep the courses that met thresholds for this demographic
  filter(if_else( hide_NA & ( is.na(!!sym(i)) | !!sym(i) %in% c("","NA","NaN") ),FALSE,TRUE) ) %>% #filter out NA values or equivalent
  group_by(course, !!sym(i)) %>%
#  filter(if_else( censor_by_removal & n() < threshold,FALSE,TRUE)) %>% #filter out censor_by_removal categories
#  summarize(DFW_rate = sum(ABCDFW == "DFW")/n(), DFW = paste0(percent(sum(ABCDFW == "DFW")/n(),accuracy=0.1),"<br><span style='white-space: nowrap;'>(",sum(ABCDFW == "DFW")," of ",n(),")</span>"),  .groups = "drop" ) %>%
  summarize(DFW_rate = if_else( censor_by_removal & n() < threshold,NA,sum(ABCDFW == "DFW")/n()), DFW = if_else( censor_by_removal & n() < threshold, "Below Threshold", paste0(percent(sum(ABCDFW != "DFW")/n(),accuracy=0.1),"<br><span style='white-space: nowrap;'>(",sum(ABCDFW != "DFW")," of ",n(),")</span>")),  .groups = "drop" ) %>%
  group_by(course) %>%
  mutate(Gap = max(DFW_rate) - min(DFW_rate)) %>%
  select(-DFW_rate) %>%
  pivot_wider(names_from = !!i, values_from=DFW) %>%
  relocate(Gap, .after = "course") %>%
  mutate(demCat = i) %>% 
  group_by(demCat) %>%
  gt(rowname_col="course") %>% # Table creation starts here
  fmt_markdown(columns = !c("course","Gap","demCat")) %>%
  fmt_percent(decimals = 1, rows = everything()) %>%
  sub_missing(missing_text="") %>%
  tab_style(
    style = cell_text(v_align = "top"),
    locations = list(cells_body(columns = everything()), cells_stub())) %>%
  tab_style_body(
      style = cell_fill(color = "yellow2"),
      values = "Below Threshold") %>%    
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(columns = Gap)) -> table_success

#GPA_exclude_DF
dt %>%
  {if(censor_by_removal == FALSE) right_join(.,courseList, by = c("course")) else .} %>% #only keep the courses that met thresholds for this demographic
  filter(if_else( hide_NA & ( is.na(!!sym(i)) | !!sym(i) %in% c("","NA","NaN") ),FALSE,TRUE) ) %>% #filter out NA values or equivalent
  group_by(course, !!sym(i)) %>%
  filter(if_else( censor_by_removal & n() < threshold,FALSE,TRUE)) %>% #filter out censor_by_removal categories
  mutate(GPA_exclude_DFW = if_else(ABCDFW=="ABC",grade_point,NaN)) %>%
  summarize(GPA_exclude_DFW = mean(GPA_exclude_DFW, na.rm=TRUE), .groups = "drop" ) %>%
  pivot_wider(names_from = !!i, values_from=GPA_exclude_DFW) %>%
  group_by(course) %>%
  mutate(Gap = max(across(!matches("course"))) - min(across(!matches("course")))) %>%
  relocate(Gap, .after = "course") %>%
  mutate(demCat = i) %>% 
  group_by(demCat) %>%
  gt(rowname_col="course") %>% # Table creation starts here
  fmt_number(decimals = 2, rows = everything()) %>%
  sub_missing(missing_text="") %>%
  tab_style_body(
      style = cell_fill(color = "yellow2"),
      values = "Below Threshold") %>%    
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(columns = Gap)) -> table_GPA

# Code to generate the interactive visualization to go with each table
dt %>%
  {if(censor_by_removal == FALSE) right_join(.,courseList, by = c("course")) else .} %>% #only keep the courses that met thresholds for this demographic
  filter(if_else( hide_NA & ( is.na(!!sym(i)) | !!sym(i) %in% c("","NA","NaN") ),FALSE,TRUE) ) %>% #filter out NA values or equivalent
  group_by(course, !!sym(i)) %>%
  filter(if_else( censor_by_removal & n() < threshold,FALSE,TRUE)) %>% #filter out censor_by_removal categories
  mutate(GPA_exclude_DFW = if_else(ABCDFW=="ABC",grade_point,NaN)) %>%
  summarize( DFW = sum(ABCDFW == "DFW")/n(), students = n(), DFW_students=sum(ABCDFW == "DFW"), GPA = mean(grade_point, na.rm=TRUE),GPA_exclude_DFW = mean(GPA_exclude_DFW, na.rm=TRUE), .groups = "drop" ) %>%
  group_by(course) %>%
  mutate(DFW_min = min(DFW), DFW_max = max(DFW), GPA_exclude_DFW_min = min(GPA_exclude_DFW), GPA_exclude_DFW_max = max(GPA_exclude_DFW) ) %>%
  mutate(students_in_gap = students*(DFW-min(DFW))) %>%
  mutate(students_in_gap = sum(students_in_gap, na.rm=TRUE), diversity = students/sum(students), total_enrollment = sum(students) ) -> b4maxCheck

# Sets scale of x-axis to 50% or highest Max + 10%
if (max(b4maxCheck$DFW_max, na.rm=TRUE) > 0.5) {
  upperLimit <- max(b4maxCheck$DFW_max, na.rm=TRUE) + 0.1}
else {
    upperLimit <- 0.5}

#DFW
b4maxCheck %>%
  arrange(desc(students)) %>%
  mutate(cat_factors = fct_reorder(!!sym(i), DFW, .desc=TRUE)) %>%
  ggplot(aes(x = DFW, y = course, fill = cat_factors)) + # Interactive plotting code starts here
  theme_classic() +
  theme(axis.text = element_text_interactive(size = 12) ) +
  theme(plot.title = element_text(hjust = 0.5)) +  
  geom_segment_interactive(aes(x = DFW_min, xend = DFW_max, yend=course, tooltip = paste(
    course,"\r",
    #!!sym(i),"\r",
    "Percentage Points Gap:",percent(DFW_max - DFW_min, accuracy = 0.1),"\r",
    "Grade Ratio:",round(DFW_max/DFW_min, digits = 2),"\r",
    "Students in Gap:",round(students_in_gap, digits = 1),"\r",
    "Total Enrollments:",total_enrollment,"\r"
    )), colour = "gray", linewidth = 15) +
  scale_size(range = c(5,15), guide = "none") +
  geom_point_interactive(aes(size = students, tooltip = paste0(
    course,"\r",
    !!sym(i)," (",percent(diversity,accuracy = 0.1)," of students)\r",
    DFW_students," of ",students," enrollments\r",
    percent(DFW, accuracy = 0.1)," DFW" )) , shape = 21) +
  scale_x_continuous(labels = scales::percent, limits = c(0,upperLimit)) +
  guides(fill = guide_legend(override.aes = list(size = 10), title= i)) +
  labs(fill = sym(i), y = "", title = "DFW Rates") -> plot


# Sets scale of x-axis to 50% or lowest Min - 10%
if (min(1-b4maxCheck$DFW_max, na.rm=TRUE) < 0.5) {
  lowerLimit <- min(1-b4maxCheck$DFW_max, na.rm=TRUE) - 0.1}
else {
    lowerLimit <- 0.5}

#Success Rates: 1 - DFW
b4maxCheck %>%
  arrange(desc(students)) %>%
  mutate(cat_factors = fct_reorder(!!sym(i), DFW, .desc=TRUE)) %>%
  mutate(Success = 1-DFW, Success_max = 1- DFW_max, Success_min = 1 - DFW_min ) %>%
  ggplot(aes(x = Success, y = course, fill = cat_factors)) + # Interactive plotting code starts here
  theme_classic() +
  theme(axis.text = element_text_interactive(size = 12) ) +
  theme(plot.title = element_text(hjust = 0.5)) +  
  geom_segment_interactive(aes(x = Success_min, xend = Success_max, yend=course, tooltip = paste(
    course,"\r",
    #!!sym(i),"\r",
    "Percentage Points Gap:",percent(Success_max - Success_min, accuracy = 0.1),"\r",
    "Grade Ratio:",round(Success_min/Success_max, digits = 2),"\r",
    "Students in Gap:",round(students_in_gap, digits = 1),"\r",
    "Total Enrollments:",total_enrollment,"\r"
    )), colour = "gray", linewidth = 15) +
  scale_size(range = c(5,15), guide = "none") +
  geom_point_interactive(aes(size = students, tooltip = paste0(
    course,"\r",
    !!sym(i)," (",percent(diversity,accuracy = 0.1)," of students)\r",
    DFW_students," of ",students," enrollments\r",
    percent(Success, accuracy = 0.1)," Success" )) , shape = 21) +
  scale_x_continuous(labels = scales::percent, limits = c(lowerLimit,1)) +
  guides(fill = guide_legend(override.aes = list(size = 10), title= i)) +
  labs(fill = sym(i), y = "", title = "Success Rates (1-DFW)") -> plot_success


# Sets scale of x-axis to 3.0 or lowest GPA - 0.1
if (min(b4maxCheck$GPA_exclude_DFW_min, na.rm=TRUE) < 3.0) {
  lowerLimit <- min(b4maxCheck$GPA_exclude_DFW, na.rm=TRUE) - 0.1}
else {
    lowerLimit <- 3.0}

# Sets scale of x-axis to 3.0 or lowest GPA - 0.1
if (max(b4maxCheck$GPA_exclude_DFW_min, na.rm=TRUE) > 3.5) {
  upperLimit <- max(b4maxCheck$GPA_exclude_DFW, na.rm=TRUE) + 0.1}
else {
    upperLimit <- 3.5}

#GPA_exclude_DF
b4maxCheck %>%
  arrange(desc(students)) %>%
  mutate(cat_factors = fct_reorder(!!sym(i), DFW, .desc=TRUE)) %>%
  ggplot(aes(x = GPA_exclude_DFW, y = course, fill = cat_factors)) + # Interactive plotting code starts here
  theme_classic() +
  theme(axis.text = element_text_interactive(size = 12) ) +
  theme(plot.title = element_text(hjust = 0.5)) +
  geom_segment_interactive(aes(x = GPA_exclude_DFW_min, xend = GPA_exclude_DFW_max, yend=course, tooltip = paste(
    course,"\r",
    #!!sym(i),"\r",
    "GPA Gap:",number(GPA_exclude_DFW_max - GPA_exclude_DFW_min, accuracy = 0.01),"\r",
    "Grade Ratio:",round(GPA_exclude_DFW_max/GPA_exclude_DFW_min, digits = 2),"\r",
    "Total Enrollments:",total_enrollment,"\r"
    )), colour = "gray", linewidth = 15) +
  scale_size(range = c(5,15), guide = "none") +
  geom_point_interactive(aes(size = students, tooltip = paste0(
    course,"\r",
    !!sym(i)," (",percent(diversity,accuracy = 0.1)," of students)\r",
    students," enrollments\r",
    number(GPA_exclude_DFW, accuracy = 0.01)," GPA excluding DF" )) , shape = 21) +
  scale_x_continuous(labels = scales::number, limits = c(lowerLimit,upperLimit)) +
  guides(fill = guide_legend(override.aes = list(size = 10), title= i)) +
  labs(fill = sym(i), y = "", x = "GPA excluding DF", title = "Grade Point for ABC Students") -> plot_GPA

# Header created in markdown
cat('\n##', i , '\n')

if(show_GPA_excluding_DF) cat('\n###', i , "- DFW",  '\n')

if(show_GPA_excluding_DF) print(htmltools::tagList(girafe(ggobj = plot_success)))
else print(htmltools::tagList(girafe(ggobj = plot))) # Use htmltools::tagList() to generate multiple interactive plots # results = 'asis' must go in {}
                                                
if(show_GPA_excluding_DF) print(table_success) else print(table)

if(show_GPA_excluding_DF) cat('\n###', i , "- GPA excluding DF",  '\n')

if(show_GPA_excluding_DF) print(htmltools::tagList(girafe(ggobj = plot_GPA)))

if(show_GPA_excluding_DF) print(table_GPA)
}
```

<p>&nbsp;</p>

# Combined Demographics

::: {.questionbox data-latex=""}
::: {.center data-latex=""}
**Guiding questions:**
:::

-   How do combinations of demographics affect student success? Does each factor act additively, or is there an interaction such that the response of one factor is smaller or larger based on the other factor? 

-   Mouse over the circles to consider the percentage of students in each demographic combination. Is there a combination of demographics that are disproportionately represented in a course? Does that surprise you? Alternatively, does it surprise you that not all students are in that combination of demographics?

-   While avoiding blaming students for their socioeconomic situation, what kinds of background and current conditions may underlie the patterns seen here? Are there pedagogical strategies that could be used to close these differences.
:::

<p>&nbsp;</p>

```{r Combined Demographics, results = 'asis', echo=FALSE, include=TRUE, warning = FALSE, eval = TRUE}
#initialize
metThresholds  <- tibble(
  course = factor(),
  met = logical(),
  demograph1 = character(),
  demograph2 = character(),
  unmet_list = character())

#determine which categories have met minimum thresholds
# Note that 'threshold' is manually set in top chunk above.
for (i in combn(demographicCols,2,simplify=FALSE)) {
dt %>%
  group_by(course) %>%
  filter(if_else( hide_NA & (( is.na(!!sym(i[1])) | !!sym(i[1]) %in% c("","NA","NaN") ) | ( is.na(!!sym(i[2])) | !!sym(i[2]) %in% c("","NA","NaN") ) ),FALSE,TRUE) ) %>% #filter out NA values or equivalent
  count(!!sym(i[1]),!!sym(i[2])) %>% #!!sym(i) take the string feed to it in the for loop and turns it into a symbol
  group_by(course) %>%
  mutate(met = !max(n < threshold)) %>% #threshold
  mutate(unmet_pre_list = if_else(n < threshold, paste(!!sym(i[1]),!!sym(i[2]),sep = "-"), NA) ) %>%
  mutate(unmet_list = str_flatten(unmet_pre_list, collapse = ", ", last = " and ", na.rm = TRUE)) %>%
  select(course,met, unmet_list) %>%
  distinct() %>%
  mutate(demograph1= i[1], demograph2 = i[2]) %>%
  union_all(metThresholds) -> metThresholds
}

metThresholds %>%
  {if(censor_by_removal == FALSE) filter(.,met == TRUE) else .} %>% #if just doing censor_by_removal graph everything otherwise filter to just those that have met across all categories.
  mutate(demograph12 = factor(paste(demograph1,demograph2,sep = " & "))) -> combosToPlot

#Get names of course and demographic combinations that did not met the threshold
metThresholds %>%
  filter(met == FALSE) %>%
  mutate(demograph12 = factor(paste(demograph1,demograph2,sep = " & "))) %>%
  group_by(demograph12, unmet_list) %>%
  summarise(courses = str_flatten(course, collapse = ", ", last = " and "),.groups = "drop") %>%
  transmute(unmet = paste("-",demograph12,"for",courses, "had too few students in the category", unmet_list)) %>%
  pull(unmet) %>%
  paste0(collapse = "\n\n")-> droppedCols

#Print names of removed columns
if (droppedCols != "") cat("\nThe following are not shown because they did not meet minimum threshold of students for all categories:\n\n",droppedCols,'\n', sep="")

# Loops through all possible pairs of columns that have passed the privacy check
for (i in levels(combosToPlot$demograph12) ) {
  # One pair of categories to work with:
  #pair <- c(keptCols1[i], keptCols2[i]) 
  
 combosToPlot %>% 
    filter(demograph12 == i) %>%
    select(course) %>%
    distinct() -> courseList #Tibble of courses that met threshold for this demographic
  
  combosToPlot %>% 
    ungroup() %>%
    filter(demograph12 == i) %>%
    select(demograph1, demograph2) %>%
    distinct() %>%
    pivot_longer(cols = c(demograph1, demograph2)) %>%
    pull(value) -> pair

#DFW
dt %>%
    {if(censor_by_removal == FALSE) right_join(.,courseList, by = c("course")) else .} %>% #only keep the courses that met thresholds for this demographic
    filter(if_else( hide_NA & ( is.na(!!sym(pair[1])) | !!sym(pair[1]) %in% c("","NA","NaN") ) & ( is.na(!!sym(pair[2])) | !!sym(pair[2]) %in% c("","NA","NaN") ),FALSE,TRUE) ) %>% #filter out NA values or equivalent
    group_by(course,!!sym(pair[1]),!!sym(pair[2])) %>%
    summarize(DFW_rate = if_else( censor_by_removal & n() < threshold,NA,sum(ABCDFW == "DFW")/n()), DFW = if_else( censor_by_removal & n() < threshold, "Below Threshold", paste0(percent(sum(ABCDFW == "DFW")/n(),accuracy=0.1),"<br><span style='white-space: nowrap;'>(",sum(ABCDFW == "DFW")," of ",n(),")</span>")),  .groups = "drop" ) %>%
    group_by(course) %>%
    mutate(Gap = max(DFW_rate) - min(DFW_rate)) %>% # Calculates the gap percentage
    select(-DFW_rate) %>%
    pivot_wider(names_from = c(!!pair[1],!!pair[2]), values_from=c(DFW)) %>%
    relocate(Gap, .after = "course") %>%
    mutate(demCat = paste(!!pair[1], "&", !!pair[2]) ) %>%
    group_by(demCat) %>% #create table
    gt(rowname_col="course") %>%
    fmt_markdown(columns = !c("course","Gap","demCat")) %>%
    fmt_percent( decimals = 1, rows=everything()) %>%
    sub_missing(missing_text="") %>%
    tab_style(
      style = cell_text(v_align = "top"),
      locations = list(cells_body(columns = everything()), cells_stub())) %>%
    tab_style_body(
      style = cell_fill(color = "yellow2"),
      values = "Below Threshold") %>%    
    tab_style(
      style = cell_text(weight = "bold"),
      locations = cells_body(columns = Gap)) %>%
    tab_spanner_delim(delim="_") -> table

#Code for interactive visualization starts here
dt %>%
  {if(censor_by_removal == FALSE) right_join(.,courseList, by = c("course")) else .} %>% #only keep the courses that met thresholds for this demographic
  filter(if_else( hide_NA & ( is.na(!!sym(pair[1])) | !!sym(pair[1]) %in% c("","NA","NaN") ) & ( is.na(!!sym(pair[2])) | !!sym(pair[2]) %in% c("","NA","NaN") ),FALSE,TRUE) ) %>% #filter out NA values or equivalent
  group_by(course, !!sym(pair[1]), !!sym(pair[2])) %>%
  filter(if_else( censor_by_removal & n() < threshold,FALSE,TRUE)) %>% #filter out censor_by_removal categories
  summarize(DFW = sum(ABCDFW == "DFW")/n(), students=n(), DFW_students=sum(ABCDFW == "DFW"), .groups = "drop" ) %>%
  group_by(course) %>%
  mutate(DFW_min = min(DFW), DFW_max = max(DFW) ) %>%
  #Creates labels for each category of intersection
  mutate(intersection = paste(!!sym(pair[1]),!!sym(pair[2]), sep = "-")) %>%
  mutate(students_in_gap = students*(DFW-min(DFW))) %>%
  mutate(students_in_gap = sum(students_in_gap, na.rm=TRUE), diversity = students/sum(students), total_enrollment = sum(students) ) -> b4maxCheck

# Sets scale of x-axis to 50% or highest Max + 10%
if (max(b4maxCheck$DFW_max, na.rm=TRUE) > 0.5) {
  upperLimit <- max(b4maxCheck$DFW_max, na.rm=TRUE) + 0.1 
  } else { 
  upperLimit <- 0.5 
  }

b4maxCheck %>%
  arrange(desc(students)) %>%
  mutate(intersection = fct_reorder(intersection, DFW, .desc=TRUE)) %>%
  ggplot(aes(x = DFW, y = course, size = students, fill = intersection)) + #Plotting code starts here
  theme_classic() +
  theme(axis.text = element_text_interactive(size = 12) ) +
  geom_segment_interactive(aes(x = DFW_min, xend = DFW_max, yend=course, tooltip = paste(
    course,"\r",
    "Percentage Points Gap:",percent(DFW_max - DFW_min, accuracy = 0.1),"\r",
    "Grade Ratio:",round(DFW_max/DFW_min, digits = 2),"\r",
    "Students in Gap:",round(students_in_gap, digits = 1),"\r",
    "Total Enrollments:",total_enrollment,"\r"
    )), colour = "gray", linewidth = 15) +
  scale_size(range = c(5,15), guide = "none") +
  geom_point_interactive(aes(size = students, tooltip = paste0(
    course,"\r",
    intersection," (",percent(diversity,accuracy = 0.1)," of students)\r",
    DFW_students," of ",students," enrollments\r",
    percent(DFW, accuracy = 0.1)," DFW" )) , shape = 21) +
  scale_x_continuous(labels = scales::percent, limits = c(0,upperLimit)) +
  guides(fill = guide_legend(override.aes = list(size = 5), title="")) +
    labs(y = "")-> plot
  
  #Creates title in Markdown format
  cat('\n##', i , '\n')
  #prints interactive visualization
  print(htmltools::tagList(girafe(ggobj = plot)))
  #prints table
  print(table)
}
#}
```

<p>&nbsp;</p>

# Across Time

`r if(censor_by_removal == FALSE) "If any demographic category does not meet the minimum threshold for number of enrollments in a term, the data will be aggregated for that term across all categories and labelled as **Aggregated**." else "If any demographic category does not meet the minimum threshold for number of enrollments in a term, the data for that category will **not appear** but other categories will be displayed."`

::: {.questionbox data-latex=""}
::: {.center data-latex=""}
**Guiding questions:**
:::

-   Are gaps increasing or decreasing over time? 

-   Are absolute DFW rates increasing or decreasing over time?

-   Are there patterns of COVID influence and/or post-COVID changes?

-   Consider changes that have been made to a course over time. Does that change correlate to any changes in the gap or the absolute DFW rates?
:::

```{r Across Time, results='asis', echo=FALSE, include=TRUE, eval = TRUE}
#initialize
metThresholds  <- tibble(
  course = factor(),
  term = factor(),
  met = logical(),
  demograph = character())

#determine which categories have met minimum thresholds
# Note that 'threshold' is manually set in top chunk above.
for (i in demographicCols) {
dt %>%
  group_by(course,term) %>%
  filter(if_else( hide_NA & ( is.na(!!sym(i)) | !!sym(i) %in% c("","NA","NaN") ),FALSE,TRUE) ) %>% #filter out NA values or equivalent
  count(!!sym(i)) %>% #!!sym(i) take the string feed to it in the for loop and turns it into a symbol
  mutate(met = !max(n < threshold)) %>% #threshold
  select(course,term,met) %>%
  distinct() %>%
  mutate(demograph = i) %>%
  union_all(metThresholds) -> metThresholds
}

metThresholds %>%
  mutate(demograph = factor(demograph), course = factor(course)) %>%
  ungroup() -> combosToPlot #in this case, keep all met values, but only plot a semester disaggregated if met = TRUE

# Generate a table for each demographic category included
for(j in levels(combosToPlot$course)) {
  # Header created in markdown
  cat('\n##', j , '\n')
  
  for (i in levels(combosToPlot$demograph)) {

#DFW    
dt %>%
  filter(course == j) %>%
  left_join(combosToPlot %>% filter(demograph == i, course == j) %>% select(term,met), by = c("term")) %>%
  group_by(term) %>%
  filter(if_else( hide_NA & ( is.na(!!sym(i)) | !!sym(i) %in% c("","NA","NaN") ),FALSE,TRUE) ) %>% #filter out NA values or equivalent
  mutate(!!sym(i) := if_else( censor_by_removal==FALSE & met == FALSE,"Aggregated",!!sym(i))) %>%
  group_by(term,!!sym(i)) %>%
  summarize(DFW_rate = if_else( censor_by_removal & n() < threshold,NA,sum(ABCDFW == "DFW")/n()), DFW = if_else( censor_by_removal & n() < threshold, "Below Threshold", paste0(percent(sum(ABCDFW == "DFW")/n(),accuracy=0.1),"<br><span style='white-space: nowrap;'>(",sum(ABCDFW == "DFW")," of ",n(),")</span>")),  .groups = "drop" ) %>%
  group_by(term) %>%    
  mutate(Gap = max(DFW_rate,na.rm=TRUE) - min(DFW_rate,na.rm=TRUE) ) %>%
  select(-DFW_rate) %>%
  pivot_wider(names_from = !!i, values_from=DFW) %>%
  relocate(Gap, .after = "term") %>%
  mutate(demCat = i) %>% 
  group_by(demCat) %>%
  mutate(term = as.character(term)) %>% #change term from factor into character to avoid error code with fmt_markdown
  gt(rowname_col="term") %>% # Table creation starts here
  fmt_markdown(columns = !c("Gap","demCat")) %>%
  fmt_percent(decimals = 1, rows = everything()) %>%
  sub_missing(missing_text="") %>%
  tab_style(
      style = cell_text(v_align = "top"),
      locations = list(cells_body(columns = everything()), cells_stub())) %>%
  tab_style_body(
      style = cell_fill(color = "yellow2"),
      values = "Below Threshold") %>%    
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(columns = Gap)) -> table
    
# Code to generate the interactive visualization to go with each table
dt %>%
  filter(course == j) %>%
  left_join(combosToPlot %>% filter(demograph == i, course == j) %>% select(term,met), by = c("term")) %>%
  group_by(term) %>%
  filter(if_else( hide_NA & ( is.na(!!sym(i)) | !!sym(i) %in% c("","NA","NaN") ),FALSE,TRUE) ) %>% #filter out NA values or equivalent
  mutate(!!sym(i) := if_else( censor_by_removal==FALSE & met == FALSE,"Aggregated",!!sym(i))) %>%
  group_by(term,!!sym(i)) %>%
  filter(if_else( censor_by_removal & n() < threshold,FALSE,TRUE)) %>% #filter out censor_by_removal categories
  summarize( DFW = sum(ABCDFW == "DFW")/n(), students = n(), DFW_students=sum(ABCDFW == "DFW"), .groups = "drop" ) %>%
  group_by(term) %>%
  mutate(DFW_min = min(DFW), DFW_max = max(DFW) ) %>%
  mutate(students_in_gap = students*(DFW-min(DFW))) %>%
  mutate(students_in_gap = sum(students_in_gap, na.rm=TRUE), diversity = students/sum(students), total_enrollment = sum(students) ) -> b4maxCheck

# Sets scale of x-axis to 50% or highest Max + 10%
if (max(b4maxCheck$DFW_max, na.rm=TRUE) > 0.5) {
  upperLimit <- max(b4maxCheck$DFW_max, na.rm=TRUE) + 0.1}
else {
    upperLimit <- 0.5}

b4maxCheck %>%
  arrange(desc(students)) %>%
  mutate(cat_factors = fct_reorder(!!sym(i), DFW, .desc=TRUE)) %>%
  ggplot(aes(x = term, y = DFW, fill = cat_factors)) + 
  theme_classic() +
  theme(axis.text = element_text_interactive(size = 12) ) +
  geom_segment_interactive(aes(y = DFW_min, yend = DFW_max, xend=term, tooltip = paste(
    term,"\r",
    !!sym(i),"\r",
    "Percentage Points Gap:",percent(DFW_max - DFW_min, accuracy = 0.1),"\r",
    "Grade Ratio:",round(DFW_max/DFW_min, digits = 2),"\r",
    "Students in Gap:",round(students_in_gap, digits = 1),"\r",
    "Total Enrollments:",total_enrollment,"\r"
    )), colour = "gray", linewidth = 15) +
  scale_size(range = c(5,15), guide = "none") +
  geom_point_interactive(aes(size = students, tooltip = paste0(
    term,"\r",
    !!sym(i)," (",percent(diversity,accuracy = 0.1)," of students)\r",
    DFW_students," of ",students," enrollments\r",
    percent(DFW, accuracy = 0.1)," DFW" )) , shape = 21) +
  scale_y_continuous(labels = scales::percent, limits = c(0,upperLimit)) +
  guides(fill = guide_legend(override.aes = list(size = 10), title="")) + #include title above legend with title = i
  theme(axis.text.x=element_text(angle = 90, hjust = 0)) +
  labs(fill = sym(i)) -> plot

# Header created in markdown
cat('\n###', j ,":", i, '\n')

print(htmltools::tagList(girafe(ggobj = plot))) # Use htmltools::tagList() to generate multiple interactive plots # results = 'asis' must go in {}
                                                
print(table)
}}
```

<p>&nbsp;</p>

# Resources for Change

Books and articles that summarize resources for pedagogical strategies.

-   [The Norton Guide to Equity-Minded Teaching](https://seagull.wwnorton.com/equityguide) by Artze-Vega, Darby, Dewsbury, and Imad (2023). This is  available as a free download.

-   [Inclusive Teaching: Strategies for Promoting Equity in the College Classroom](https://wvupressonline.com/inclusive-teaching) by Hogan and Sathy (2022). 

-   [Handelsman et al (2022)](https://www.science.org/doi/10.1126/science.abn9515) in Science

-   [Tanner (2013)](https://www.lifescied.org/doi/10.1187/cbe.13-06-0115) in CBE Life Sciences Education

Online repositories of pedagogical strategies.
 
-   [Student Experience Project](https://studentexperienceproject.org/resources/)

-   [CBE Life Science Education's Guide to Inclusive Teaching](https://lse.ascb.org/evidence-based-teaching-guides/inclusive-teaching/)

-   [University of Michigan's Inclusive Teaching Strategies](https://crlt.umich.edu/multicultural-teaching/inclusive-teaching-strategies)

Free online courses that aim to guide instructors in mindset and attitude.

-   [The Inclusive STEM Teaching Project](https://www.inclusivestemteaching.org/)

-   [HHMI Biointeractive's Inclusive Teaching](https://www.biointeractive.org/professional-learning/online-courses/inclusive-teaching)

# Notes

`r if(censor_by_removal == FALSE) "A demographic column must meet the minimum threshold for number of students in all categories in order to be displayed. If a column does not meet the minimum threshold, and you anticipate that it should, check your data for typos which could be inadvertently creating another category in that column."`

In order to meet thresholds for race-ethnicity in small-enrollment courses, you can combine categories to overcome threshold minimums, for example combining categories into underrepresented. When doing so, be intentional and clear.

Options can be adjusted in the code for this report that do the following:

-   Adjust the minimum threshold for required for a demographic factor.

-   When a threshold is not met either aggregate the whole demographic factor or just remove the single category which did not meet the threshold.

-   Hide or show NA values.

-   Display just DFW rates or display success rates (1-DFW) along with the the GPA of students who had A, B, or C grades.

## Credit

Contributors to this code include Tim Gabriel and Chad E. Brassil at the University of Nebraska-Lincoln. Funding for this report was provided by HHMI as part of the IE3 program. This report was inspired by and uses code from the SELC Equity Report which is part of the SEISMIC Project.

```{r Bug Fix, include = FALSE}
# The girafe library appears to need execute a non-tagListed girafe object into order to render the support functions for the html browser to work. So have this execute, but set include = FALSE so that it does not display anything.
dt %>%
  group_by(course) %>%
  summarize( DFW = sum(ABCDFW == "DFW"), .groups = "drop" ) %>%
  ggplot(aes(x = DFW, y = course)) +
  geom_point_interactive(aes(tooltip = paste0(course,"\r")),shape = 21) ->p

girafe(ggobj = p)
```

```{r, include = FALSE}
# Contributors to this code include: Tim Gabriel and Chad E. Brassil at the University of Nebraska-Lincoln
# This report was inspired by and uses code from the SELC Equity Report
```

