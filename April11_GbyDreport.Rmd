---
title: "HHMI Mini-Project Visualization Example"
author: "Chad E. Brassil, Faculty Director of Undergraduate Analytics"
date: "December 2023, edited 4/11/24"
output: html_document
---

```{r setup, include=FALSE}
# This is example code designed to work with the simulated data. It can be reused and modified to work with local data from an institution.
## Setup
# You can use the Knit feature to generate an html file or a pdf file from this document, which can then be shared with others.

knitr::opts_chunk$set(echo = TRUE) #used to display code in html
```

```{css, echo=FALSE}
.gt_table {
  float:left;
}
```

```{r, include=FALSE}
# Pair with GitHub
# library(usethis)
# use_git_config(user.name = "Tim Gabriel", user.email = "tgabriel2@unl.edu")
```

```{r libraries, include=FALSE, message = FALSE}
#Load libraries and data

#The default will be to look for data_sim.csv file in the same folder in which you have this R file. If you format your own institutional data similar to the data_sim.csv #file, the code should work on your institutional data as well.

library(tidyverse)
library(gt)
ds <- read_csv("data_sim.csv")
```

```{r, include=FALSE}
# Add acceptable column names here:
courseColumns <- c("course","Course","class","Class")
termColumns <- c("term","Term","AMIS","Amis_Term_Code")
gradeColumns <- c("grade","Grade","Letter_Grade","letter_grade")
semesterColumns <- c("semester","Semester","year_and_semester","Year_and_Semester")

# Check for "course"
columnNames <- colnames(ds)
hasCourseCol <- any(courseColumns %in% columnNames)
if (hasCourseCol){
   print("course column found")
} else {
   stop("course column not found") }

# Check for "term"
hasTermCol <- any(termColumns %in% columnNames)
if (hasTermCol){
   print("term column found") 
} else {
   stop("term column not found") }

# Check for "grade"
hasGradeCol <- any(gradeColumns %in% columnNames)
if (hasGradeCol){
   print("grade column found") 
} else {
   stop("grade column not found") }

# Check for "semester"
hasSemesterCol <- any(semesterColumns %in% columnNames)
if (hasSemesterCol){
   print("semester column found") 
} else {
   stop("semester column not found") }
```

```{r, echo=FALSE}
# Isolate demographic columns
demographicCols <- c()

for (col in columnNames) {
  if (!(col %in% courseColumns || col %in% termColumns || col %in% gradeColumns || col %in% semesterColumns)) {
    demographicCols <- c(demographicCols, col)
  }
}
```

```{r, include=FALSE}
## Data Cleaning
# Add a grade_point and a DFW column to the data
ds %>%
  mutate(grade_point = case_when(
    grade == "A+" ~ 4.0,
    grade == "A" ~ 4.0,
    grade == "A-" ~ 3.67,
    grade == "B+" ~ 3.33,
    grade == "B" ~ 3.0,
    grade == "B-" ~ 2.67,
    grade == "C+" ~ 2.33,
    grade == "C" ~ 2.0,
    grade == "C-" ~ 1.67,
    grade == "D+" ~ 1.33,
    grade == "D" ~ 1.0,
    grade == "D-" ~ 0.67,
    grade == "F" ~ 0.0,
    TRUE ~ NaN)) %>%
  mutate(ABCDFW = case_when(
    grade %in% c("A+","A","A-","B+","B","B-","C+","C","C-") ~ "ABC",
    grade %in% c("D+","D","D-","F","W") ~ "DFW",
    TRUE ~ NA)) -> dt
```


```{r, include = FALSE}
# Isolates one course as d1
# Change input course here to generate differing reports (Chem1 or Calc1):
inputCourse <- "Chem1"
dt %>%
  filter(course == as.character(inputCourse)) -> d1

```

```{r, include=FALSE}
# To Do:
# Remove Gap number Total
# Add note about students
# Removed columns formatting with commas and &
# reduce size of vizzes in {r}
# Max vizzes at 60% if Max is less than 50%

# Factors, forcats categories, change data type, orders of categories
# reduce transparency
# move tables to be near vizzes
# add mouse over
```

```{r, results='asis', echo=FALSE}
# Threshold Number of Students or Fewer Check for Privacy
threshold <- 5
# Aggregate columns that violate privacy concerns, removed from output
keptCols <- c()
droppedCols <- c()

for (i in demographicCols) {
  counts <- d1 %>%
  count(!!sym(i))
  
  if(any(counts$n < threshold)) {
    droppedCols <- c(droppedCols, i)
  }
  else {
    keptCols <- c(keptCols, i)
  }
}

if (length(droppedCols) != 0) {
  cat("Removed for privacy:",droppedCols)
}
```

## DFW Rate by Demographic Category for `r d1$course[1]`
#### The number of students in each category is listed under the percentage.

```{r, results='asis', echo=FALSE, include=FALSE}
# Generate a table for each demographic category included
for (i in keptCols) {
  d1 %>%
  group_by(course, !!sym(i)) %>%
  summarize(DFW = sum(ABCDFW == "DFW")/n(), .groups = "drop" ) %>%
  pivot_wider(names_from = !!i, values_from=DFW) %>%
  mutate(Gap = max(across(!matches("course"))) - min(across(!matches("course")))) %>%
  relocate(Gap, .after = "course") %>%
  select(-course) %>%
    # Demographic Category Label moves to the left side
  mutate(demCat = i) %>%
  gt(rowname_col="demCat") %>%
  fmt_percent(decimals = 1) %>%
  tab_style(style = cell_text(weight = "bold"),
            locations = cells_body(columns = c(Gap))) %>%
  print()
}
```


```{r, results='asis', echo=FALSE, include=TRUE}
# Generate a table for each demographic category included
for (i in keptCols) {
  d1 %>%
  group_by(course, !!sym(i)) %>%
  summarize(students=n(), .groups = "drop" ) %>%
  pivot_wider(names_from = !!i, values_from=students) %>%
  mutate(Gap = " ", demCat = " ") %>%
  relocate(Gap, .after = "course") %>%
  relocate(demCat, .after = "Gap") %>%
  select(-course) -> numStudents
  
  d1 %>%
  group_by(course, !!sym(i)) %>%
  summarize(DFW = sum(ABCDFW == "DFW")/n(), .groups = "drop" ) %>%
  pivot_wider(names_from = !!i, values_from=DFW) %>%
  mutate(Gap = max(across(!matches("course"))) - min(across(!matches("course")))) %>%
  mutate(Gap = format(round(Gap * 100, digits = 1), nsmall = 1)) %>%
  mutate(Gap = as.character(Gap)) %>%
  mutate(Gap = paste0(Gap,'%')) %>%
  relocate(Gap, .after = "course") %>%
  select(-course) %>%
  mutate(demCat = i) %>% 
  relocate(demCat, .after = "Gap") %>% 
  rbind(numStudents) %>%
  gt(rowname_col="demCat") %>%
  tab_style(style = cell_text(weight = "bold"),
            locations = cells_body(columns = c(Gap))) %>%
  fmt_percent(decimals = 1, rows = 1) %>%
  print()
}
```

<br><br><br><br><br>

## DFW Rate Intersectionality Tables for `r d1$course[1]`
#### The number of students in each category is listed under the percentage.

```{r, results='asis', echo=FALSE}
# Aggregate columns that violate privacy concerns, removed from output
keptColsInt <- c()
droppedColsInt <- c()

for (i in combn(demographicCols,2,simplify=FALSE)) {

    countsInt <- d1 %>%
    group_by(course,!!sym(i[1]),!!sym(i[2])) %>%
    summarize(students=n(), .groups = "drop" )
  
  if(any(countsInt$students < threshold)) {
    droppedColsInt <- c(droppedColsInt, i)
  }
  else {
    keptColsInt <- c(keptColsInt, i)
  }
}

if (length(droppedColsInt) != 0) {
  formattedPairs <- ""
  for (j in seq(1, length(droppedColsInt), by = 2)) {
    formattedPairs <- paste(formattedPairs, droppedColsInt[j], sep = "")
    if (j + 1 <= length(droppedColsInt)) {
      formattedPairs <- paste(formattedPairs, " & ", droppedColsInt[j + 1], sep = "")
    }
    formattedPairs <- paste(formattedPairs, ", ", sep = "")
  }
  formattedPairs <- sub(", $", "", formattedPairs)
  
  cat("Removed for privacy:", formattedPairs)
}
```

```{r, results = 'asis', echo=FALSE, include=TRUE}

for (i in seq(from = 1, to = length(keptColsInt), by=2)) {
  pair <- c(keptColsInt[i], keptColsInt[i+1]) 

d1 %>%
    group_by(course, !!sym(pair[1]), !!sym(pair[2])) %>%
    summarize(students=n(), .groups = "drop" ) %>%
    pivot_wider(names_from = c(!!sym(pair[1]), !!sym(pair[2])), values_from=students) %>%
    mutate(Gap = " ", demCat = " ") %>%
    relocate(Gap, .after = "course") %>%
    relocate(demCat, .after = "Gap") %>%
    select(-course) -> numStudentsInt

  d1 %>%
    group_by(course,!!sym(pair[1]),!!sym(pair[2])) %>%
    summarize( DFW = sum(ABCDFW == "DFW")/n(), .groups = "drop" ) %>%
    pivot_wider(names_from = c(!!pair[1],!!pair[2]), values_from=DFW) %>%
    mutate(Gap = max(across(!matches("course"))) - min(across(!matches("course")))) %>%
    mutate(Gap = format(round(Gap * 100, digits = 1), nsmall = 1)) %>%
    mutate(Gap = as.character(Gap)) %>%
    mutate(Gap = paste0(Gap,'%')) %>%
    relocate(Gap, .after = "course") %>%
    select(-course) %>%
    mutate(demCat = paste(!!pair[1], "&", !!pair[2]) ) %>%
    rbind(numStudentsInt) %>%
    gt(rowname_col="demCat") %>%
    fmt_percent( 
    decimals = 1, rows=1
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(columns = Gap)) %>%
  tab_spanner_delim(delim="_") %>%
    print()
}
```

```{r, results = 'asis', echo=FALSE, include=FALSE}

for (i in combn(keptCols,2,simplify=FALSE)) {
  
d1 %>%
    group_by(course,!!sym(i[1]),!!sym(i[2])) %>%
    summarize( DFW = sum(ABCDFW == "DFW")/n(), .groups = "drop" ) %>%
    pivot_wider(names_from = c(!!i[1],!!i[2]), values_from=DFW) %>%
    mutate(Gap = max(across(!matches("course"))) - min(across(!matches("course")))) %>%
    relocate(Gap, .after = "course") %>%
    ungroup() %>%
    select(-course) %>%
    mutate(demCat = paste(!!i[1], "&", !!i[2]) ) %>%
    gt(rowname_col="demCat") %>%
    fmt_percent( 
    decimals = 1
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(columns = Gap)) %>%
  tab_spanner_delim(delim="_") %>%
    print()
}
```

<br><br><br><br><br>

## DFW Rate Visualizations for `r d1$course[1]`

```{r, echo=FALSE, include=TRUE, fig.height=4}

for (i in keptCols) { 
d1 %>%
  group_by(course, !!sym(i)) %>%
  summarize( DFW = sum(ABCDFW == "DFW")/n(), students = n(), .groups = "drop" ) %>%
  group_by(course) %>%
  mutate(DFW_min = min(DFW), DFW_max = max(DFW) ) -> b4maxCheck
  
  
if (b4maxCheck$DFW_max[1] > 0.5) {
  upperLimit <- b4maxCheck$DFW_max[1] + 0.1 }
else { upperLimit <- 0.5 }
  
  b4maxCheck %>%
  arrange(desc(students)) -> sorted_d1
  
  sorted_d1 %>%
    pull(!!sym(i)) -> cat_sorted
    
  sorted_d1 %>%
  mutate(cat_factors = factor(!!sym(i), levels = cat_sorted)) %>% 
    
  
  ggplot(aes(x = DFW, y = course, fill = cat_factors)) +
  theme_classic() +
  geom_segment(aes(x = DFW_min, xend = DFW_max, yend=course),colour = "gray", linewidth = 15) +
  scale_size(range = c(5,15), guide = "none") + #use range to set min and max size of circles
  geom_point(aes(size = students),shape = 21) +
  scale_x_continuous(labels = scales::percent, limits = c(0,upperLimit)) +
  guides(fill = guide_legend(override.aes = list(size = 10))) +
  labs(fill = sym(i), y = "Course") +
  ggtitle(paste(i, "DFW Rates")) -> plot
print(plot)
}
```


```{r, include=FALSE}
## Create Tables
# Simple code to examine a metric
dt %>%
  group_by(course,gender) %>%
  summarize(mean_gpa = mean(grade_point,na.rm=TRUE), count=n(), DFWcount = sum(ABCDFW == "DFW"),DFW = sum(ABCDFW == "DFW")/n(), .groups = "drop")

```


```{r, include=FALSE}
# More elaborate code to rearrange table and calculate gap in percentage points
dt %>%
  group_by(course,gender) %>%
  summarize( DFW = sum(ABCDFW == "DFW")/n(), .groups = "drop" ) %>%
  pivot_wider(names_from = gender, values_from=DFW) %>%
  group_by(course) %>%
  mutate(Gap = max(across(!matches("course"))) - min(across(!matches("course"))))

```

```{r, include=FALSE}
# Format into a table
dt %>%
  group_by(course,gender) %>%
  summarize( DFW = sum(ABCDFW == "DFW")/n(), .groups = "drop" ) %>%
  pivot_wider(names_from = gender, values_from=DFW) %>%
  group_by(course) %>%
  mutate(Gap = max(across(!matches("course"))) - min(across(!matches("course")))) %>%
  relocate(Gap, .after = "course") %>%
  ungroup() %>%
  gt(rowname_col = "course") %>%
  fmt_percent(
    decimals = 1
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(columns = c(Gap))
  )%>%
  tab_header(title = "DFW")
```


<p>&nbsp;</p>


```{r, include=FALSE}
#Intersectionality table with renamed labels and polished formatting
dt %>%
  group_by(course,gender,firstgen) %>%
  mutate(firstgen = if_else(firstgen == "Y", "First", "Continuing")) %>%
  summarize( DFW = sum(ABCDFW == "DFW")/n(), .groups = "drop" ) %>%
  pivot_wider(names_from = c(gender,firstgen), values_from=DFW) %>%
  group_by(course) %>%
  mutate(Gap = max(across(!matches("course"))) - min(across(!matches("course")))) %>%
  relocate(Gap, .after = "course") %>%
  ungroup()%>%
  gt(rowname_col = "course") %>%
  fmt_percent( 
    decimals = 1
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(columns = Gap)) %>%
  tab_spanner_delim(delim="_") %>%
    tab_header(title = "DFW")
```

<p>&nbsp;</p>


```{r, echo=FALSE, include=FALSE}
## Create Figures
#This illustrates how we are going to rearrange the data to prepare it for plotting
dt %>%
  group_by(course,firstgen) %>%
  summarize( DFW = sum(ABCDFW == "DFW")/n(), students = n(), .groups = "drop" ) %>%
  group_by(course) %>%
  mutate(DFW_min = min(DFW), DFW_max = max(DFW) ) %>%
  mutate(firstgen = if_else(firstgen == "Y", "FirstGen", "Continuing"))
```

```{r, echo=FALSE, include=FALSE}
#Using Factors
d1 %>%
  group_by(course,race_ethnicity) %>%
  summarize( DFW = sum(ABCDFW == "DFW")/n(), students = n(), .groups = "drop" ) %>%
  group_by(course) %>%
  mutate(DFW_min = min(DFW), DFW_max = max(DFW) ) %>%
  arrange(desc(students)) -> sorted_d1

sorted_d1 %>%
  pull(race_ethnicity) -> cat_sorted

sorted_d1 %>%
  mutate(race_ethnicity = factor(race_ethnicity, levels = cat_sorted)) %>%
  ggplot(aes(x = DFW, y = course, fill = race_ethnicity)) + #plotting code starts here
  theme_classic() +
  geom_segment(aes(x = DFW_min, xend = DFW_max, yend=course),colour = "gray", linewidth = 15) +
  scale_size(range = c(5,15), guide = "none") + #use range to set min and max size of circles
  geom_point(aes(size = students),shape = 21) +
  scale_x_continuous(labels = scales::percent, limits = c(0,1)) +
  guides(fill = guide_legend(override.aes = list(size = 10))) +
  labs(fill = "race_ethnicity", y = "Course")
```

```{r, echo=FALSE, include=FALSE}
#Dress it up into plot
dt %>%
  group_by(course,firstgen) %>%
  summarize( DFW = sum(ABCDFW == "DFW")/n(), students = n(), .groups = "drop" ) %>%
  group_by(course) %>%
  mutate(DFW_min = min(DFW), DFW_max = max(DFW) ) %>%
  mutate(firstgen = if_else(firstgen == "Y", "FirstGen", "Continuing")) %>%
  ggplot(aes(x = DFW, y = course, fill = firstgen)) + #plotting code starts here
  theme_classic() +
  geom_segment(aes(x = DFW_min, xend = DFW_max, yend=course),colour = "gray", linewidth = 15) +
  scale_size(range = c(5,15), guide = "none") + #use range to set min and max size of circles
  geom_point(aes(size = students),shape = 21) +
  scale_x_continuous(labels = scales::percent, limits = c(0,1)) +
  guides(fill = guide_legend(override.aes = list(size = 10))) +
  labs(fill = "Generation", y = "Course")
```


```{r, include=FALSE}
#Create interactive tooltips, i.e. mouseovers, using ggiraph library
library(ggiraph)
library(scales) #used for percent formatting
```



```{r, include=FALSE}
# Note, this may not display correctly in R, but should work when knit into an html
dt %>%
  group_by(course,firstgen) %>%
  summarize( DFW = sum(ABCDFW == "DFW")/n(), students = n(), DFW_students=sum(ABCDFW == "DFW"), .groups = "drop" ) %>% #added line to store DFW students explicitly
  group_by(course) %>%
  mutate(DFW_min = min(DFW), DFW_max = max(DFW)) %>% 
  mutate(students_in_gap = students[which.max(DFW)]*(max(DFW)-min(DFW)), diversity = students/sum(students), total_enrollment = sum(students) ) %>% #added students in gap calculation
  mutate(firstgen = if_else(firstgen == "Y", "FirstGen", "Continuing")) %>%
  ggplot(aes(x = DFW, y = course, fill = firstgen)) +
  theme_classic() +
  geom_segment_interactive(aes(x = DFW_min, xend = DFW_max, yend=course, tooltip = paste(
    course,"\r",
    firstgen,"\r",
    "Percentage Points Gap:",percent(DFW_max - DFW_min, accuracy = 0.1),"\r",
    "Grade Ratio:",round(DFW_max/DFW_min, digits = 2),"\r",
    "Students in Gap:",round(students_in_gap, digits = 1),"\r",
    "Total Enrollments:",total_enrollment,"\r"
    )),colour = "gray", linewidth = 15) + # change this to _interactive version in ggiraph and add tooltip code
  scale_size(range = c(5,15), guide = "none") + #use range to set min and max size of circles
  geom_point_interactive(aes(size = students, tooltip = paste0(
    course,"\r",
    firstgen," (",percent(diversity,accuracy = 0.1)," of students)\r",
    DFW_students," of ",students," enrollments\r",
    percent(DFW, accuracy = 0.1)," DFW"
    )),shape = 21) + # change this to _interactive version in ggiraph and add tooltip code
  scale_x_continuous(labels = scales::percent, limits = c(0,1)) +
  guides(fill = guide_legend(override.aes = list(size = 10))) +
  labs(fill = "Generation", y = "Course") ->p

girafe(ggobj=p)
```


```{r, include=FALSE}
dt %>%
  filter(course == "Calc1") %>%
  group_by(course,semester,firstgen) %>%
  summarize( DFW = sum(ABCDFW == "DFW")/n(), students = n(), .groups = "drop" ) %>%
  group_by(course, semester) %>%
  mutate(DFW_min = min(DFW), DFW_max = max(DFW) ) %>%
  mutate(firstgen = if_else(firstgen == "Y", "FirstGen", "Continuing")) %>%
  ggplot(aes(x = semester, y = DFW, size = students, fill = firstgen)) + #plotting code starts here
  theme_classic() +
  geom_linerange(aes(ymin = DFW_min, ymax = DFW_max), colour = "grey", linewidth = 10) +
  scale_size(range = c(5,15), guide = "none") + #use range to set min and max size of circles
  geom_point(shape = 21) +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  guides(fill = guide_legend(override.aes = list(size = 10))) +
  theme(axis.text.x = element_text(angle=90, vjust=.5, hjust=1)) +
  labs(fill = "Generation", x = "Semester")
```


```{r, include=FALSE}
dt %>%
  group_by(course,gender, firstgen) %>%
  summarize( DFW = sum(ABCDFW == "DFW")/n(), students = n(), .groups = "drop" ) %>%
  group_by(course) %>%
  mutate(DFW_min = min(DFW), DFW_max = max(DFW) ) %>%
  mutate(firstgen = if_else(firstgen == "Y", "FirstGen", "Continuing")) %>%
  mutate(intersection = paste(gender,firstgen, sep = "-")) %>%
  ggplot(aes(x = DFW, y = course, size = students, fill = intersection)) + #plotting code starts here
  theme_classic() +
  geom_linerange(aes(xmin = DFW_min, xmax = DFW_max), colour = "grey", linewidth = 15) + #coordinate linewidth with max size of circles
  scale_size(range = c(2,15), guide = "none") + #use range to set min and max size of circles
  geom_point(shape = 21, alpha = 0.49) +
  scale_x_continuous(labels = scales::percent, limits = c(0,1)) +
  guides(fill = guide_legend(override.aes = list(size = 10))) + 
  labs(fill = "Gender-Generation", y = "Course")
```
